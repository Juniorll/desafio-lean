<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Jornada LEAN: O Desafio do Gerente</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Anti-Cheat: Desabilita seleção de texto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Classes auxiliares para mostrar/esconder telas */
        .game-screen {
            display: none; /* Todas as telas começam escondidas */
        }
        .game-screen.active {
            display: block; /* A tela ativa é mostrada */
        }

        /* Estilo para itens de opção nos desafios */
        .option-item {
            transition: all 0.2s ease-in-out;
        }
        .option-item:hover:not(.disabled) {
            transform: translateY(-4px);
            background-color: #374151; /* gray-700 */
            border-color: #06b6d4; /* cyan-500 */
        }
        .option-item.selected {
            background-color: #0891b2; /* cyan-600 */
            border-color: #06b6d4; /* cyan-500 */
            color: white;
        }
        .option-item.correct {
            background-color: #10B981 !important; /* green-500 */
            border-color: #059669 !important;
            color: white;
        }
        .option-item.wrong {
            background-color: #EF4444 !important; /* red-500 */
            border-color: #DC2626 !important;
            color: white;
        }
        .option-item.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Estilos para o mapa da jornada */
        .journey-module {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(80%);
        }
        .journey-module.current {
            opacity: 1;
            cursor: pointer;
            filter: grayscale(0%);
            border-color: #f59e0b; /* amber-500 */
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        .journey-module.completed {
            opacity: 1;
            cursor: default;
            filter: grayscale(0%);
            border-color: #10B981; /* green-500 */
            background-color: #1f2937; /* gray-800 */
        }
        .journey-module.completed .journey-status {
            color: #10B981;
            content: 'Concluído!';
        }

        /* Estilo para o Kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .kanban-column {
            min-width: 180px; /* Um pouco menor para caber mais */
            flex: 1;
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        .kanban-column-title {
            font-weight: 700;
            color: #e5e7eb; /* gray-200 */
            border-bottom: 2px solid #374151; /* gray-700 */
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        .kanban-card {
            background-color: #374151; /* gray-700 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .kanban-column.bottleneck {
            border: 2px solid #EF4444; /* red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        /* Estilo para Toast Anti-Cheat */
        #toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #EF4444; /* red-500 */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #DC2626;
            z-index: 100;
            font-weight: 600;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        #toast-notification.active {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8 flex items-center justify-center">

    <!-- Container Principal do Jogo -->
    <div classs="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-gray-700">

        <!-- Cabeçalho do Jogo (fixo) -->
        <header class="flex justify-between items-center pb-4 border-b border-gray-700 mb-6">
            <div>
                <h1 id="game-title" class="text-xl md:text-3xl font-black text-cyan-400">JORNADA LEAN</h1>
                <p id="player-name-display" class="text-sm text-gray-400">Iniciado: (Nenhum)</p>
            </div>
            <div class="text-right">
                <div class="text-lg md:text-2xl font-bold text-yellow-400">
                    <span id="score-display">0</span> PONTOS
                </div>
            </div>
        </header>

        <!-- === TELA 1: BOAS-VINDAS === -->
        <div id="welcome-screen" class="game-screen active">
            <h2 class="text-2xl font-bold mb-4">Bem-vindo à sua Jornada LEAN!</h2>
            <p class="text-gray-300 mb-6">
                Você foi desafiado a se tornar um "Faixa-Branca" em LEAN. Sua missão é otimizar processos em dois cenários diferentes.
            </p>
            
            <div class="bg-red-900 border border-red-600 text-red-100 p-4 rounded-lg mb-6">
                <h3 class="font-bold text-lg mb-2">ATENÇÃO, INICIADO! (ANTI-CHEAT ATIVO)</h3>
                <p>
                    Sua <span class="font-bold text-red-300">PONTUAÇÃO</span> é o seu resultado final. Respostas erradas <span class="font-bold text-red-300">descontam pontos</span>!
                </p>
                <p class="mt-2">
                    O sistema detectará se você <span class="font-bold">sair desta tela ou tentar capturá-la</span> durante um <span class="font-bold">DESAFIO</span>.
                    Qualquer tentativa resultará em uma <span class="font-bold text-lg">penalidade de -150 PONTOS</span>. Jogue limpo!
                </p>
            </div>

            <!-- Input de Nome (só aparece se o nome não estiver salvo) -->
            <div id="name-input-area" class="mb-6">
                <input type="text" id="player-name-input" placeholder="Digite seu nome para a classificação..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            </div>

            <!-- Botões de Seleção de Jornada -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="start-game-btn" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                    Jornada 1: Pizzaria (Normal)
                </button>
                <button id="start-level2-btn-welcome" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                    Jornada 2: Oficina (Difícil)
                </button>
            </div>
        </div>

        <!-- === TELA 2: JORNADA (MAPA) === -->
        <div id="journey-screen" class="game-screen">
            <h2 id="journey-title" class="text-2xl font-bold mb-6">Sua Jornada LEAN (Faixa-Branca)</h2>
            <div id="journey-map" class="space-y-4">
                <!-- Módulos serão injetados aqui pelo JS -->
            </div>
        </div>

        <!-- === TELA 3: ESTUDO (APRENDIZADO) === -->
        <div id="learn-screen" class="game-screen">
            <h2 id="learn-title" class="text-3xl font-black mb-4 text-cyan-400"></h2>
            <div id="learn-content" class="text-gray-300 space-y-4 max-h-[50vh] overflow-y-auto pr-4">
                <!-- Conteúdo do Estudo será injetado aqui -->
            </div>
            <button id="start-challenge-btn" class="w-full mt-6 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Entendido! Ir para o Desafio!
            </button>
        </div>

        <!-- === TELA 4: DESAFIO === -->
        <div id="challenge-screen" class="game-screen">
            <h2 id="challenge-title" class="text-2xl font-bold text-center mb-2 text-yellow-400"></h2>
            <p id="challenge-task" class="text-gray-300 text-center mb-6"></p>
            <div id="challenge-area" class="space-y-4">
                <!-- Perguntas e Opções do Desafio serão injetadas aqui -->
            </div>
            <button id="submit-challenge-btn" class="w-full mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Verificar Respostas
            </button>
            <div id="challenge-feedback" class="mt-4 text-center"></div>
        </div>

        <!-- === TELA 5: RESULTADO DO DESAFIO === -->
        <div id="result-screen" class="game-screen text-center">
            <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
            <p id="result-message" class="text-lg text-gray-300 mb-6"></p>
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-sm mx-auto mb-6">
                <p class="text-sm text-gray-400">Pontuação do Desafio:</p>
                <p id="result-score" class="text-4xl font-black text-yellow-400"></p>
            </div>
            <button id="next-module-btn" class="w-full max-w-sm mx-auto bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Voltar para a Jornada
            </button>
        </div>

        <!-- === TELA 6: PONTUAÇÃO FINAL === -->
        <div id="final-screen" class="game-screen text-center">
            <h2 id="final-title" class="text-3xl font-black mb-4 text-cyan-400">Jornada Concluída!</h2>
            <p id="final-player-name" class="text-xl font-semibold mb-4"></p>
            
            <div id="final-scores-area" class="bg-gray-900 border-2 border-cyan-500 rounded-lg p-8 w-full max-w-md mx-auto mb-6 shadow-2xl">
                <!-- Pontuações serão injetadas aqui -->
            </div>
            
            <p id="final-cheats" class="text-sm text-red-400 mb-6"></p>
            
            <!-- Botão para Voltar ao Início -->
            <button id="go-home-btn" class="w-full max-w-sm mx-auto mt-4 bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Voltar ao Início
            </button>
        </div>

    </div> <!-- Fim do Container Principal -->

    <!-- === TOAST ANTI-CHEAT === -->
    <div id="toast-notification">
        Mensagem de Teste
    </div>


    <script>
        // --- BANCO DE DADOS DE JOGOS ---
        // Contém os dados de todas as jornadas
        const gameData = {
            // Nível 1: Pizzaria
            pizzaria: [
                { 
                    id: 1, 
                    name: "Módulo 1: Fundamentos LEAN e o 'Valor'", 
                    status: "locked",
                    learnTitle: "Módulo 1: O que é 'Valor'?",
                    learnContent: `
                        <p class="text-lg">Bem-vindo ao LEAN (Manufatura Enxuta). Pense no LEAN como uma filosofia para <span class="font-bold text-cyan-300">eliminar desperdícios</span> e focar apenas no que realmente importa.</p>
                        <p>O conceito mais importante do LEAN é o <span class="font-bold text-white">VALOR</span>.</p>
                        <p class="font-bold text-xl mt-4">Valor é qualquer coisa pela qual o CLIENTE está disposto a pagar.</p>
                        <p>Se o cliente não paga por isso, provavelmente é um desperdício (em LEAN, chamamos de 'Muda').</p>
                        <h4 class="text-lg font-bold mt-4 text-cyan-300">Exemplos na Pizzaria:</h4>
                        <ul class="list-disc list-inside space-y-2 pl-4">
                            <li>O cliente <span class="text-green-400 font-bold">PAGA</span> por:
                                <ul class="list-disc list-inside pl-6">
                                    <li>Ingredientes de qualidade.</li>
                                    <li>Massa sendo aberta e montada.</li>
                                    <li>Pizza assando no forno.</li>
                                    <li>Entrega rápida e correta.</li>
                                </ul>
                            </li>
                            <li>O cliente <span class="text-red-400 font-bold">NÃO PAGA</span> para:
                                <ul class="list-disc list-inside pl-6">
                                    <li>O pizzaiolo <span class="font-bold">procurar</span> o queijo na geladeira.</li>
                                    <li>O gerente <span class="font-bold">refazer</span> uma pizza que saiu errada.</li>
                                    <li>A pizza ficar <span class="font-bold">esperando</span> na prateleira o motoboy chegar.</li>
                                    <li>O motoboy <span class="font-bold">caminhar</span> 50 metros para pegar a pizza.</li>
                                </ul>
                            </li>
                        </ul>
                        <p class="mt-4">No próximo desafio, seu trabalho é provar que você entendeu o que é 'Valor' do ponto de vista do cliente.</p>
                    `,
                    challengeTitle: "Desafio 1: O que é Valor? (Pizzaria)",
                    challengeTask: "Selecione TODAS as atividades pelas quais um cliente de pizzaria estaria disposto a pagar. (Múltipla escolha)",
                    challengeData: [
                        { text: "Assar a pizza no forno.", isValue: true },
                        { text: "O pizzaiolo andando até a geladeira.", isValue: false },
                        { text: "Usar ingredientes frescos (queijo, tomate).", isValue: true },
                        { text: "O motoboy esperando o pedido ficar pronto.", isValue: false },
                        { text: "Dobrar a caixa de papelão para a pizza.", isValue: true },
                        { text: "Refazer uma pizza que queimou.", isValue: false },
                        { text: "A pizza parada na prateleira esfriando.", isValue: false },
                        { text: "O pizzaiolo montando a pizza (molho, queijo, etc).", isValue: true },
                        { text: "Procurar a comanda do pedido que sumiu.", isValue: false }
                    ],
                    pointsPerCorrect: 20,
                    pointsPerWrong: -10
                },
                { 
                    id: 2, 
                    name: "Módulo 2: Os 7 Desperdícios (MUDA)", 
                    status: "locked",
                    learnTitle: "Módulo 2: O Vilão 'MUDA'",
                    learnContent: `
                        <p class="text-lg">Agora que você sabe o que é 'Valor', vamos caçar o vilão: <span class="font-bold text-red-400">MUDA (Desperdício)</span>.</p>
                        <p>Existem 7 tipos clássicos de 'Muda'. Decore o acrônimo <span class="font-bold text-white">T.I.M. W.O.O.D.</span> (em inglês) ou S.T.O.M.P.E.D. (em português).</p>
                        
                        <h4 class="text-lg font-bold mt-4 text-cyan-300">Os 7 Desperdícios:</h4>
                        <ul class="list-none space-y-3 pl-2">
                            <li><span class="font-bold text-xl text-white">1. TRANSPORTE:</span>
                                <p class="text-sm">Mover <span class="font-bold">produtos/materiais</span> de um lugar para outro. (Ex: Levar a massa do freezer até a bancada do outro lado da loja).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">2. INVENTÁRIO (Estoque):</span>
                                <p class="text-sm">Mais material ou produto parado do que o necessário. (Ex: Comprar 1.000 caixas de pizza que ficarão paradas por 6 meses ocupando espaço).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">3. MOVIMENTAÇÃO:</span>
                                <p class="text-sm">Mover <span class="font-bold">pessoas</span> ou equipamentos desnecessariamente. (Ex: O pizzaiolo ter que dar 5 passos para pegar o molho e 10 passos para pegar o queijo).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">4. WAITING (Espera):</span>
                                <p class="text-sm">Pessoas ou máquinas paradas esperando o próximo passo. (Ex: Pizza pronta esperando o motoboy; Pizzaiolo parado esperando o forno esquentar).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">5. OVER-PRODUCTION (Superprodução):</span>
                                <p class="text-sm">Produzir mais, mais rápido ou antes do necessário. (Ex: Fazer 20 pizzas de mussarela às 17h "só para adiantar", e elas estragarem).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">6. OVER-PROCESSING (Superprocessamento):</span>
                                <p class="text-sm">Fazer mais trabalho do que o cliente valoriza. (Ex: Colocar a pizza em uma caixa, depois em uma sacola de plástico, depois em uma sacola de papel).</p>
                            </li>
                            <li><span class="font-bold text-xl text-white">7. DEFEITOS:</span>
                                <p class="text-sm">Erros que exigem correção ou refazer o trabalho. (Ex: Pizza queimada; Enviar sabor errado; Endereço de entrega errado).</p>
                            </li>
                        </ul>
                    `,
                    challengeTitle: "Desafio 2: Caça aos Desperdícios",
                    challengeTask: "Você tem dois desafios! Primeiro, na Pizzaria. Depois, em um Festival de Música. Classifique cada problema com seu 'Muda' (Desperdício) correspondente.",
                    challengeData: { // Dados específicos do Desafio 2
                        pizzaria: [
                            { q: "O pizzaiolo anda 10 passos para pegar o queijo e 10 para voltar.", a: "Movimentação" },
                            { q: "A pizza fica pronta e espera 15 min na prateleira pelo motoboy.", a: "Espera" },
                            { q: "Fizeram 10 pizzas de calabresa 'para adiantar', mas só venderam 2.", a: "Superprodução" },
                            { q: "A pizza queimou e teve que ser jogada fora e refeita.", a: "Defeitos" },
                            { q: "O motoboy leva a pilha de massas do freezer para a bancada (do outro lado da loja).", a: "Transporte" },
                            { q: "Temos 5.000 caixas de pizza paradas no estoque há 3 meses.", a: "Inventário" },
                            { q: "Colocamos a pizza na caixa, depois na sacola, depois amarramos um laço de fita.", a: "Superprocessamento" }
                        ],
                        festival: [
                            { q: "Compraram 20.000 copos para o evento, mas só 8.000 pessoas apareceram.", a: "Inventário" },
                            { q: "O caminhão de bebidas descarregou a 500m do bar principal. Tiveram que levar tudo em carrinhos.", a: "Transporte" },
                            { q: "O técnico de som precisa andar do palco até a mesa de som (no meio do público) toda hora.", a: "Movimentação" },
                            { q: "A banda 1 terminou, mas a banda 2 está atrasada. O palco fica vazio por 30 min.", a: "Espera" },
                            { q: "O telão mostra o logo do patrocinador 50x antes do show começar.", a: "Superprocessamento" },
                            { q: "O microfone do cantor falha no meio do show.", a: "Defeitos" },
                            { q: "Imprimiram 10.000 panfletos extras que não foram distribuídos.", a: "Superprodução" }
                        ],
                        tiposMuda: ["Transporte", "Inventário", "Movimentação", "Espera", "Superprodução", "Superprocessamento", "Defeitos"]
                    },
                    pointsPerCorrect: 15,
                    pointsPerWrong: -5
                },
                { 
                    id: 3, 
                    name: "Módulo 3: Melhoria Contínua (Kaizen e 5S)", 
                    status: "locked",
                    learnTitle: "Módulo 3: As Ferramentas da Mudança",
                    learnContent: `
                        <p class="text-lg">Você já sabe identificar 'Valor' e 'Desperdício'. Agora, como arrumamos a casa? Com duas ferramentas: <span class="font-bold text-cyan-300">5S</span> e <span class="font-bold text-cyan-300">KAIZEN</span>.</p>
                        
                        <h4 class="text-lg font-bold mt-4 text-white">1. KAIZEN (Melhoria Contínua)</h4>
                        <p>Kaizen significa "mudar para melhor". É a filosofia de que <span class="font-bold">pequenas melhorias, feitas todos os dias,</span> geram resultados gigantescos. Em vez de gastar R$ 50.000 num forno novo (o que não é Kaizen), o Kaizen pergunta: "O que podemos fazer HOJE, de graça ou quase de graça, para melhorar 1%?"</p>
                        <p class="font-bold">Ex: "Vamos etiquetar as gavetas de ingredientes." (Pequena mudança, grande impacto na 'Movimentação').</p>
                        
                        <h4 class="text-lg font-bold mt-4 text-white">2. 5S (A Ferramenta de Organização)</h4>
                        <p>O Kaizen mais fácil de começar é o 5S. É um método japonês para organizar o local de trabalho.</p>
                        <ul class="list-none space-y-2 pl-2">
                            <li><span class="font-bold text-xl text-white">1S. Seiri (Utilização):</span> <span class="text-sm">SEPARAR o útil do inútil. Jogue fora o que não usa.</span></li>
                            <li><span class="font-bold text-xl text-white">2S. Seiton (Organização):</span> <span class="text-sm">COLOCAR cada coisa útil em seu devido lugar. "Um lugar para cada coisa, e cada coisa em seu lugar."</span></li>
                            <li><span class="font-bold text-xl text-white">3S. Seiso (Limpeza):</span> <span class="text-sm">LIMPAR o local de trabalho.</span></li>
                            <li><span class="font-bold text-xl text-white">4. Seiketsu (Padronização):</span> <span class="text-sm">CRIAR regras (visuais) para manter os 3S. (Ex: Etiquetar a gaveta "Colheres").</span></li>
                            <li><span class="font-bold text-xl text-white">5S. Shitsuke (Disciplina):</span> <span class="text-sm">MANTER o hábito de seguir as regras.</span></li>
                        </ul>
                        <p class="mt-4">Seu desafio será aplicar o 5S e o Kaizen na nossa pizzaria.</p>
                    `,
                    challengeTitle: "Desafio 3: A Grande Arrumação (Pizzaria)",
                    challengeTask: "Este desafio tem 3 etapas: Aplicar 'Seiri' (Descarte), 'Seiton' (Organização) e 'Kaizen' (Melhoria).",
                    challengeData: {
                        seiri: [
                            { item: "Rolo de massa", isUseless: false },
                            { item: "Tomate estragado", isUseless: true },
                            { item: "Espátula", isUseless: false },
                            { item: "Celular pessoal do pizzaiolo", isUseless: true },
                            { item: "Molho de tomate (aberto)", isUseless: false },
                            { item: "Embalagem de queijo vazia", isUseless: true },
                            { item: "Queijo ralado", isUseless: false },
                            { item: "Comanda de pedido de ontem", isUseless: true },
                            { item: "Farinha", isUseless: false }
                        ],
                        seiton: [
                            { item: "Rolo de massa", local: "Bancada", localCorreto: "Bancada" },
                            { item: "Molho de tomate (aberto)", local: "Bancada", localCorreto: "Geladeira" },
                            { item: "Espátula", local: "Perto do Forno", localCorreto: "Perto do Forno" },
                            { item: "Queijo ralado", local: "Perto do Forno", localCorreto: "Geladeira" },
                            { item: "Farinha", local: "Geladeira", localCorreto: "Bancada" }
                        ],
                        kaizen: [
                            { 
                                q: "Problema: O pizzaiolo perde tempo procurando ingredientes na geladeira (Muda: Movimentação).",
                                options: [
                                    { text: "Comprar uma geladeira maior e mais moderna.", isBest: false },
                                    { text: "Etiquetar todas as prateleiras e potes dentro da geladeira.", isBest: true },
                                    { text: "Contratar um assistente só para pegar coisas na geladeira.", isBest: false }
                                ]
                            },
                            {
                                q: "Problema: Os motoboys pegam os pedidos errados com frequência (Muda: Defeito).",
                                options: [
                                    { text: "Gritar com os motoboys para prestarem mais atenção.", isBest: false },
                                    { text: "Criar um sistema de prateleiras numeradas (1, 2, 3) e grampear a comanda na sacola.", isBest: true },
                                    { text: "Dar 50% de desconto para o cliente que receber o pedido errado.", isBest: false }
                                ]
                            }
                        ]
                    },
                    pointsPerCorrect: 10,
                    pointsPerWrong: -5
                },
                { 
                    id: 4, 
                    name: "Módulo 4: Ferramentas de Controle (Kanban e Poka-Yoke)", 
                    status: "locked",
                    learnTitle: "Módulo 4: Controlando o Processo",
                    learnContent: `
                        <p class="text-lg">Você organizou a casa (5S) e sabe melhorar (Kaizen). Agora, vamos controlar o fluxo de trabalho com <span class="font-bold text-cyan-300">Kanban</span> e <span class="font-bold text-cyan-300">Poka-Yoke</span>.</p>
                        
                        <h4 class="text-lg font-bold mt-4 text-white">1. KANBAN (Gestão Visual)</h4>
                        <p>Kanban é uma palavra japonesa que significa "cartão visual". É um sistema para <span class="font-bold">visualizar o trabalho, limitar o trabalho em progresso (WIP) e maximizar a eficiência</span>.</p>
                        <p>Em vez de o pizzaiolo tentar fazer 10 pizzas ao mesmo tempo (o que gera caos), o Kanban sugere um limite. Por exemplo: "No máximo 3 pizzas na bancada de 'Preparo' ao mesmo tempo".</p>
                        <p class="font-bold">Quando a coluna 'Preparo' está cheia (atingiu o limite de 3), o pizzaiolo <span class="text-red-400">NÃO DEVE</span> puxar um novo pedido da coluna 'A Fazer'. Ele deve, primeiro, ajudar a mover uma pizza de 'Preparo' para 'Assando', liberando espaço. Isso evita gargalos!</p>
                        
                        <h4 class="text-lg font-bold mt-4 text-white">2. POKA-YOKE (À Prova de Erros)</h4>
                        <p>Poka-Yoke é qualquer mecanismo que ajuda a <span class="font-bold">prevenir que um erro humano aconteça</span>. O objetivo é tornar impossível fazer errado.</p>
                        <ul class="list-disc list-inside space-y-2 pl-4">
                            <li><span class="font-bold">Exemplo 1:</span> O conector USB-C. Você não consegue encaixar do lado errado. Isso é um Poka-Yoke físico.</li>
                            <li><span class="font-bold">Exemplo 2 (Pizzaria):</span> O pizzaiolo sempre esquece o orégano. Um Poka-Yoke seria uma colher de orégano com o cabo feito para encaixar em cima da alça do cortador de pizza. Ele <span class="font-bold">tem</span> que pegar o orégano para conseguir pegar o cortador.</li>
                            <li><span class="font-bold">Exemplo 3 (Sistema):</span> O sistema do caixa não deixa fechar o pedido se o campo "telefone" não tiver 9 dígitos. Isso previne o erro de anotar telefone errado.</li>
                        </ul>
                    `,
                    challengeTitle: "Desafio 4: Produção Inteligente (Pizzaria)",
                    challengeTask: "Desafio em duas etapas: Analise o quadro Kanban e depois crie soluções Poka-Yoke.",
                    challengeData: {
                        kanban: { 
                            q: "O quadro Kanban da pizzaria está assim. A coluna 'Em Preparo' tem limite de 3 pizzas (WIP=3), mas já tem 5! Qual a AÇÃO LEAN correta a se fazer IMEDIATAMENTE?",
                            options: [
                                { text: "Puxar mais 2 pedidos de 'A Fazer' para 'Em Preparo' para adiantar.", isBest: false },
                                { text: "Focar em mover pizzas de 'Pronto' para 'Entrega' para liberar espaço.", isBest: false },
                                { text: "PARAR de puxar pedidos de 'A Fazer' e ajudar a mover as 5 pizzas de 'Em Preparo' para 'Assando'.", isBest: true },
                                { text: "Contratar mais um pizzaiolo para a coluna 'Em Preparo'.", isBest: false }
                            ]
                        },
                        pokaYoke: [
                            { 
                                q: "Problema: O pizzaiolo às vezes usa a massa errada (normal vs. integral).",
                                options: [
                                    { text: "Treinar o pizzaiolo novamente.", isBest: false },
                                    { text: "Armazenar as massas em potes de CORES diferentes (Ex: Pote Verde = Integral).", isBest: true },
                                    { text: "Pesar a massa toda vez antes de usar.", isBest: false }
                                ]
                            },
                            {
                                q: "Problema: O motoboy esquece de pegar a máquina de cartão.",
                                options: [
                                    { text: "Multar o motoboy em R$ 10,00 a cada esquecimento.", isBest: false },
                                    { text: "Colocar um gancho para a chave da moto em CIMA da máquina de cartão (ele tem que pegar a máquina para pegar a chave).", isBest: true },
                                    { text: "Ligar para o cliente e perguntar se ele pode pagar em dinheiro.", isBest: false }
                                ]
                            }
                        ]
                    },
                    pointsPerCorrect: 25,
                    pointsPerWrong: -10
                }
            ],
            // Nível 2: Oficina Mecânica
            oficina: [
                { 
                    id: 1, 
                    name: "Módulo 1: O 'Valor' na Oficina", 
                    status: "locked",
                    learnTitle: "Módulo 1: O que é 'Valor'? (Nível 2)",
                    learnContent: `
                        <p class="text-lg">Bem-vindo à Jornada Nível 2: A Oficina Mecânica. Os conceitos são os mesmos, mas o cenário é novo e mais desafiador.</p>
                        <p class="font-bold text-xl mt-4">Lembre-se: Valor é o que o CLIENTE paga. Todo o resto é desperdício (Muda).</p>
                        <h4 class="text-lg font-bold mt-4 text-cyan-300">Exemplos na Oficina:</h4>
                        <ul class="list-disc list-inside space-y-2 pl-4">
                            <li>O cliente <span class="text-green-400 font-bold">PAGA</span> por:
                                <ul class="list-disc list-inside pl-6">
                                    <li>Diagnóstico correto do problema.</li>
                                    <li>Peça nova sendo instalada.</li>
                                    <li>Alinhamento e balanceamento.</li>
                                </ul>
                            </li>
                            <li>O cliente <span class="text-red-400 font-bold">NÃO PAGA</span> para:
                                <ul class="list-disc list-inside pl-6">
                                    <li>O mecânico <span class="font-bold">procurar</span> uma ferramenta.</li>
                                    <li>O carro ficar <span class="font-bold">parado</span> no pátio esperando uma peça chegar.</li>
                                    <li>O mecânico <span class="font-bold">refazer</span> um conserto que ficou errado.</li>
                                </ul>
                            </li>
                        </ul>
                    `,
                    challengeTitle: "Desafio 1: O que é Valor? (Oficina)",
                    challengeTask: "Nível Difícil: Selecione TODAS as atividades que agregam valor real para o cliente da oficina.",
                    challengeData: [
                        { text: "Diagnosticar o barulho do motor com o scanner.", isValue: true },
                        { text: "Mecânico andando até o almoxarifado buscar um filtro.", isValue: false },
                        { text: "Instalar as novas pastilhas de freio.", isValue: true },
                        { text: "Carro parado no pátio esperando a aprovação do orçamento.", isValue: false },
                        { text: "Procurar a chave de roda correta na caixa de ferramentas.", isValue: false },
                        { text: "Refazer a troca de óleo porque usaram o óleo errado.", isValue: false },
                        { text: "Encher o pneu com a calibragem correta.", isValue: true },
                        { text: "Lavar o carro do cliente (serviço não solicitado e não cobrado).", isValue: false }, // Superprocessamento
                        { text: "Preencher a ordem de serviço no sistema.", isValue: true } // Necessário para o serviço
                    ],
                    pointsPerCorrect: 20,
                    pointsPerWrong: -15 // Penalidade maior
                },
                { 
                    id: 2, 
                    name: "Módulo 2: Desperdícios na Oficina", 
                    status: "locked",
                    learnTitle: "Módulo 2: O Vilão 'MUDA' (Nível 2)",
                    learnContent: `
                        <p class="text-lg">Você já conhece os 7 Desperdícios (T.I.M. W.O.O.D.). Agora, sua tarefa é identificá-los em um ambiente mais complexo.</p>
                        <p>Lembre-se: <span class="font-bold text-white">Transporte</span> (material), <span class="font-bold text-white">Inventário</span> (estoque), <span class="font-bold text-white">Movimentação</span> (pessoa), <span class="font-bold text-white">Waiting</span> (Espera), <span class="font-bold text-white">Over-production</span> (Superprodução), <span class="font-bold text-white">Over-processing</span> (Superprocessamento) e <span class="font-bold text-white">Defeitos</span>.</p>
                        <p class="mt-4">Seja rápido e preciso. Os erros aqui custam mais caro.</p>
                    `,
                    challengeTitle: "Desafio 2: Caça aos Desperdícios (Oficina)",
                    challengeTask: "Nível Difícil: Classifique cada problema da oficina com seu 'Muda' (Desperdício) correspondente.",
                    challengeData: { // Dados específicos
                        oficina: [
                            { q: "O mecânico anda 20m para pegar o scanner e 20m para voltar.", a: "Movimentação" },
                            { q: "O carro está no elevador, mas o mecânico está parado, esperando a peça vir do almoxarifado.", a: "Espera" },
                            { q: "O mecânico limpou e poliu o motor do cliente, sem ele pedir e sem cobrar.", a: "Superprocessamento" },
                            { q: "Instalaram a peça errada, o carro falhou e teve que voltar no dia seguinte.", a: "Defeitos" },
                            { q: "Um funcionário leva o carro do pátio para o elevador, depois para o alinhamento, depois de volta para o pátio.", a: "Transporte" },
                            { q: "Temos 500 filtros de ar de um modelo de carro que saiu de linha há 5 anos.", a: "Inventário" },
                            { q: "O mecânico A fez o diagnóstico, o mecânico B vai fazer o conserto e precisa re-diagnosticar.", a: "Defeitos" }, // Ou Superprocessamento
                            { q: "Compraram 1000L de óleo 10w40 'na promoção', mas a oficina só usa 50L por mês.", a: "Inventário" }
                        ],
                        tiposMuda: ["Transporte", "Inventário", "Movimentação", "Espera", "Superprodução", "Superprocessamento", "Defeitos"]
                    },
                    pointsPerCorrect: 15,
                    pointsPerWrong: -10 // Penalidade maior
                },
                { 
                    id: 3, 
                    name: "Módulo 3: Oficina Kaizen (5S)", 
                    status: "locked",
                    learnTitle: "Módulo 3: As Ferramentas da Mudança (Nível 2)",
                    learnContent: `
                        <p class="text-lg">Você sabe a teoria do <span class="font-bold text-cyan-300">5S</span> (Seiri, Seiton, Seiso, Seiketsu, Shitsuke) e <span class="font-bold text-cyan-300">KAIZEN</span> (Pequenas melhorias contínuas).</p>
                        <p>Na oficina, a desorganização (Muda: Movimentação) e os pequenos erros (Muda: Defeitos) são os maiores vilões. Seu desafio é aplicar as soluções corretas.</p>
                    `,
                    challengeTitle: "Desafio 3: A Grande Arrumação (Oficina)",
                    challengeTask: "Nível Difícil (3 etapas): Aplique 'Seiri', 'Seiton' e 'Kaizen' na oficina.",
                    challengeData: {
                        seiri: [
                            { item: "Chave de roda", isUseless: false },
                            { item: "Peça velha (quebrada) substituída", isUseless: true },
                            { item: "Scanner de diagnóstico", isUseless: false },
                            { item: "Lata de refrigerante vazia", isUseless: true },
                            { item: "Óleo novo (lacrado)", isUseless: false },
                            { item: "Chave de fenda com a ponta gasta/quebrada", isUseless: true },
                            { item: "Filtro de ar novo (na caixa)", isUseless: false },
                            { item: "Pneu furado antigo (irrecuperável)", isUseless: true }
                        ],
                        seiton: [
                            { item: "Scanner de diagnóstico", local: "Na caixa de parafusos", localCorreto: "Carrinho de diagnóstico" },
                            { item: "Chave de roda", local: "No chão, ao lado do carro", localCorreto: "Painel de ferramentas" },
                            { item: "Filtro de ar novo", local: "Carrinho de diagnóstico", localCorreto: "Almoxarifado/Prateleira" },
                            { item: "Torquímetro (ferramenta de precisão)", local: "Painel de ferramentas", localCorreto: "Estojo protegido" }
                        ],
                        kaizen: [
                            { 
                                q: "Problema: O mecânico perde tempo procurando a chave correta no painel de ferramentas (Muda: Movimentação).",
                                options: [
                                    { text: "Comprar um painel de ferramentas 3x maior.", isBest: false },
                                    { text: "Criar um 'painel de sombra' (desenho) com o contorno de cada ferramenta.", isBest: true },
                                    { text: "Manter todas as ferramentas em uma única caixa grande.", isBest: false }
                                ]
                            },
                            {
                                q: "Problema: O mecânico às vezes esquece de apertar todos os 5 parafusos da roda (Muda: Defeito Grave!).",
                                options: [
                                    { text: "Dar um bônus se ele acertar, e demitir se errar.", isBest: false },
                                    { text: "Usar um torquímetro que 'estala' e marcar cada parafuso apertado com caneta (verificação visual).", isBest: true },
                                    { text: "Pedir para o cliente verificar os parafusos antes de sair.", isBest: false }
                                ]
                            }
                        ]
                    },
                    pointsPerCorrect: 15, // Mais pontos
                    pointsPerWrong: -10
                },
                { 
                    id: 4, 
                    name: "Módulo 4: Controle de Oficina", 
                    status: "locked",
                    learnTitle: "Módulo 4: Controlando o Processo (Nível 2)",
                    learnContent: `
                        <p class="text-lg">Vamos aplicar <span class="font-bold text-cyan-300">Kanban</span> e <span class="font-bold text-cyan-300">Poka-Yoke</span> na Oficina.</p>
                        <p class="font-bold">Kanban:</p> <p>Lembre-se do Limite de Trabalho em Progresso (WIP). Se uma coluna (Ex: 'Aguardando Peça') está cheia, ela é o <span class="font-bold text-red-400">GARGALO</span>. A equipe deve focar em desobstruir o gargalo, e não em puxar mais trabalho.</p>
                        <p class="font-bold mt-2">Poka-Yoke:</p> <p>Tornar o erro impossível. Em uma oficina, onde um erro pode ser fatal, isso é crucial. Pense em soluções físicas ou de sistema que previnem o erro humano.</p>
                    `,
                    challengeTitle: "Desafio 4: Produção Inteligente (Oficina)",
                    challengeTask: "Nível Difícil (2 etapas): Identifique o gargalo Kanban e crie soluções Poka-Yoke.",
                    challengeData: {
                        kanban: { 
                            q: "O quadro Kanban da oficina tem um GARGALO óbvio. Onde ele está e qual a ação correta para o Gerente?",
                            options: [
                                { text: "Gargalo: 'Aguardando Peça'. Ação: Pressionar o almoxarifado/compras para acelerar as peças.", isBest: true },
                                { text: "Gargalo: 'Diagnóstico'. Ação: Contratar mais mecânicos para o diagnóstico.", isBest: false },
                                { text: "Gargalo: 'Em Conserto'. Ação: Puxar mais carros da 'Recepção' para não deixar os mecânicos parados.", isBest: false },
                                { text: "Gargalo: 'Recepção'. Ação: Fazer mais marketing para atrair mais clientes.", isBest: false }
                            ]
                        },
                        pokaYoke: [
                            { 
                                q: "Problema: O mecânico às vezes usa o tipo de óleo errado (Ex: 5w30 no lugar de 10w40).",
                                options: [
                                    { text: "Pintar as tampas dos galões de óleo com cores diferentes (Azul=5w30, Vermelho=10w40).", isBest: false }, // É Kaizen, mas não Poka-Yoke
                                    { text: "Usar pistolas de óleo com bicos de encaixe diferentes (o bico '5w30' não encaixa no motor '10w40').", isBest: true },
                                    { text: "Dar uma bronca severa no mecânico.", isBest: false }
                                ]
                            },
                            {
                                q: "Problema: Esquecem de devolver a porca de segurança da roda para o cliente (que fica com o carro preso se furar o pneu).",
                                options: [
                                    { text: "Colocar a porca em uma bandeja magnética vermelha que deve ser colocada no capô. O mecânico não pode fechar o capô sem tirar a bandeja.", isBest: true },
                                    { text: "Anotar na comanda 'LEMBRAR DE DEVOLVER A PORCA'.", isBest: false },
                                    { text: "Cobrar do mecânico uma porca nova se ele esquecer.", isBest: false }
                                ]
                            }
                        ]
                    },
                    pointsPerCorrect: 30,
                    pointsPerWrong: -15
                }
            ]
        };

        // --- ESTADO DO JOGO ---
        const gameState = {
            playerName: "",
            totalScore: 0,
            totalScorePizzaria: 0,
            totalScoreOficina: 0,
            currentModuleId: 1,
            challengeScore: 0,
            cheatAttempts: 0,
            isCheating: false, // Debounce
            toastTimer: null,   // Timer do Toast
            activeModules: [] // Armazena a jornada atual (Pizzaria ou Oficina)
        };

        // --- ELEMENTOS DA DOM ---
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            journey: document.getElementById('journey-screen'),
            learn: document.getElementById('learn-screen'),
            challenge: document.getElementById('challenge-screen'),
            result: document.getElementById('result-screen'),
            final: document.getElementById('final-screen'),
        };

        const ui = {
            gameTitle: document.getElementById('game-title'),
            playerNameInput: document.getElementById('player-name-input'),
            nameInputArea: document.getElementById('name-input-area'),
            playerNameDisplay: document.getElementById('player-name-display'),
            startGameBtn: document.getElementById('start-game-btn'),
            startLevel2BtnWelcome: document.getElementById('start-level2-btn-welcome'), 
            scoreDisplay: document.getElementById('score-display'),
            journeyTitle: document.getElementById('journey-title'),
            journeyMap: document.getElementById('journey-map'),
            learnTitle: document.getElementById('learn-title'),
            learnContent: document.getElementById('learn-content'),
            startChallengeBtn: document.getElementById('start-challenge-btn'),
            challengeTitle: document.getElementById('challenge-title'),
            challengeTask: document.getElementById('challenge-task'),
            challengeArea: document.getElementById('challenge-area'),
            submitChallengeBtn: document.getElementById('submit-challenge-btn'),
            challengeFeedback: document.getElementById('challenge-feedback'),
            resultTitle: document.getElementById('result-title'),
            resultMessage: document.getElementById('result-message'),
            resultScore: document.getElementById('result-score'),
            nextModuleBtn: document.getElementById('next-module-btn'),
            finalTitle: document.getElementById('final-title'),
            finalPlayerName: document.getElementById('final-player-name'),
            finalScoresArea: document.getElementById('final-scores-area'),
            finalCheats: document.getElementById('final-cheats'),
            goHomeBtn: document.getElementById('go-home-btn'), 
            toast: document.getElementById('toast-notification'),
        };

        // --- FUNÇÕES DE NAVEGAÇÃO ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            screens[screenId].classList.add('active');
        }

        function updateScore(points) {
            gameState.totalScore += points;
            gameState.challengeScore += points;
            ui.scoreDisplay.textContent = gameState.totalScore;
        }

        function validateAndSetPlayerName() {
            if (gameState.playerName === "") {
                const name = ui.playerNameInput.value.trim();
                if (name === "") {
                    ui.playerNameInput.classList.add('border-red-500', 'animate-pulse');
                    ui.playerNameInput.placeholder = "Por favor, digite seu nome para começar!";
                    return false;
                }
                gameState.playerName = name;
                ui.playerNameDisplay.textContent = `Iniciado: ${gameState.playerName}`;
                ui.nameInputArea.style.display = 'none'; 
            }
            return true;
        }
        
        function startGame() {
            if (!validateAndSetPlayerName()) return;

            gameState.totalScore = 0; 
            gameState.currentModuleId = 1;
            gameState.activeModules = JSON.parse(JSON.stringify(gameData.pizzaria));
            gameState.activeModules[0].status = 'current'; 
            
            ui.journeyTitle.textContent = "Sua Jornada LEAN (Nível 1: Pizzaria)";
            ui.gameTitle.textContent = "JORNADA LEAN: A PIZZARIA";
            ui.scoreDisplay.textContent = "0";
            
            renderJourneyMap();
            showScreen('journey');
        }
        
        function startLevel2() {
            if (!validateAndSetPlayerName()) return;
            
            gameState.totalScore = 0; 
            gameState.currentModuleId = 1;
            gameState.activeModules = JSON.parse(JSON.stringify(gameData.oficina));
            gameState.activeModules[0].status = 'current'; 

            ui.journeyTitle.textContent = "Sua Jornada LEAN (Nível 2: Oficina)";
            ui.gameTitle.textContent = "JORNADA LEAN: A OFICINA";
            ui.scoreDisplay.textContent = "0";
            
            renderJourneyMap();
            showScreen('journey');
        }

        function goHome() {
            gameState.totalScore = 0;
            gameState.currentModuleId = 1;
            gameState.activeModules = [];
            
            ui.scoreDisplay.textContent = "0";
            ui.gameTitle.textContent = "JORNADA LEAN";
            
            showScreen('welcome');
        }

        function renderJourneyMap() {
            ui.journeyMap.innerHTML = '';
            gameState.activeModules.forEach(module => {
                const moduleEl = document.createElement('div');
                moduleEl.className = `journey-module bg-gray-700 p-6 rounded-lg border-4 border-gray-600 transition-all duration-300 ${module.status}`;
                moduleEl.innerHTML = `
                    <h3 class="text-xl font-bold">${module.name}</h3>
                    <p class="journey-status text-sm font-semibold uppercase ${module.status === 'completed' ? 'text-green-400' : (module.status === 'current' ? 'text-yellow-400' : 'text-gray-500')}">
                        ${module.status === 'completed' ? 'Concluído' : (module.status === 'current' ? 'Próximo Desafio' : 'Bloqueado')}
                    </p>
                `;
                if (module.status === 'current') {
                    moduleEl.onclick = () => selectModule(module.id);
                }
                ui.journeyMap.appendChild(moduleEl);
            });
        }

        function selectModule(moduleId) {
            const module = gameState.activeModules.find(m => m.id === moduleId);
            if (!module || module.status !== 'current') return;

            ui.learnTitle.textContent = module.learnTitle;
            ui.learnContent.innerHTML = module.learnContent;
            ui.startChallengeBtn.onclick = () => startChallenge(moduleId);
            
            showScreen('learn');
        }

        function startChallenge(moduleId) {
            const module = gameState.activeModules.find(m => m.id === moduleId);
            gameState.currentModuleId = moduleId;
            gameState.challengeScore = 0; 

            ui.challengeTitle.textContent = module.challengeTitle;
            ui.challengeTask.textContent = module.challengeTask;
            ui.challengeArea.innerHTML = '';
            ui.submitChallengeBtn.onclick = null;
            ui.submitChallengeBtn.textContent = "Verificar Respostas";
            ui.submitChallengeBtn.classList.remove('hidden');
            ui.challengeFeedback.textContent = '';
            
            switch (moduleId) {
                case 1:
                    setupChallenge1(module);
                    break;
                case 2:
                    setupChallenge2(module);
                    break;
                case 3:
                    setupChallenge3(module);
                    break;
                case 4:
                    setupChallenge4(module);
                    break;
            }
            
            showScreen('challenge');
        }

        function showResult(success, message) {
            ui.resultTitle.textContent = success ? "Desafio Concluído!" : "Módulo Falhou!";
            ui.resultMessage.textContent = message;
            ui.resultScore.textContent = `${gameState.challengeScore > 0 ? '+' : ''}${gameState.challengeScore}`;
            
            const module = gameState.activeModules.find(m => m.id === gameState.currentModuleId);
            module.status = 'completed';

            const nextModule = gameState.activeModules.find(m => m.id === gameState.currentModuleId + 1);
            if (nextModule) {
                nextModule.status = 'current';
                ui.nextModuleBtn.textContent = "Voltar para a Jornada";
                ui.nextModuleBtn.onclick = () => {
                    renderJourneyMap();
                    showScreen('journey');
                };
            } else {
                ui.nextModuleBtn.textContent = "Ver Pontuação Final";
                ui.nextModuleBtn.onclick = showFinalScreen;
            }

            showScreen('result');
        }
        
        function showFinalScreen() {
            ui.finalPlayerName.textContent = `Iniciado: ${gameState.playerName}`;
            ui.finalCheats.textContent = gameState.cheatAttempts > 0 ? `Tentativas de trapaça detectadas: ${gameState.cheatAttempts}` : '';

            const isPizzaria = gameState.activeModules[0].name.includes("Pizzaria");
            
            if (isPizzaria) {
                gameState.totalScorePizzaria = gameState.totalScore; 
                ui.finalTitle.textContent = "Jornada 1 Concluída!";
            } else {
                gameState.totalScoreOficina = gameState.totalScore; 
                ui.finalTitle.textContent = "Jornada 2 Concluída!";
            }

            ui.finalScoresArea.innerHTML = '';
            if (gameState.totalScorePizzaria > 0 || gameState.activeModules.length === 0) { // Mostra se tiver pontuação ou se estiver voltando da tela de Oficina
                 ui.finalScoresArea.innerHTML += `
                    <p class="text-lg text-gray-400">Pontuação (Pizzaria):</p>
                    <p class="text-4xl font-black text-yellow-400 mb-4">${gameState.totalScorePizzaria}</p>
                `;
            }
            if (gameState.totalScoreOficina > 0) {
                 ui.finalScoresArea.innerHTML += `
                    <p class="text-lg text-gray-400">Pontuação (Oficina):</p>
                    <p class="text-4xl font-black text-yellow-400">${gameState.totalScoreOficina}</p>
                `;
            }
            
            showScreen('final');
        }

        // --- LÓGICA DOS DESAFIOS ---

        // Desafio 1: O que é Valor? (Genérico)
        function setupChallenge1(module) {
            const shuffledData = shuffleArray([...module.challengeData]);
            
            shuffledData.forEach(item => {
                const itemEl = createOptionItem(item.text, { 'isValue': item.isValue });
                ui.challengeArea.appendChild(itemEl);
            });
            
            ui.submitChallengeBtn.onclick = () => {
                const options = ui.challengeArea.querySelectorAll('.option-item');
                const { correct, wrong } = checkMultiSelect(options, 'isValue');
                
                const points = (correct * module.pointsPerCorrect) + (wrong * module.pointsPerWrong);
                updateScore(points);
                
                ui.submitChallengeBtn.classList.add('hidden');
                const message = `Você acertou ${correct} e errou ${wrong}. Lembre-se: Valor é só o que o cliente pagaria!`;
                setTimeout(() => showResult(true, message), 2000);
            };
        }
        
        // Desafio 2: Os 7 Desperdícios (Genérico)
        function setupChallenge2(module) {
            const isPizzaria = module.name.includes("Módulo 2");
            let allQuestions = [];
            
            if (isPizzaria) {
                allQuestions = [
                    ...shuffleArray(module.challengeData.pizzaria).map(q => ({...q, context: "Na Pizzaria:"})),
                    ...shuffleArray(module.challengeData.festival).map(q => ({...q, context: "No Festival:"}))
                ];
            } else {
                allQuestions = shuffleArray(module.challengeData.oficina).map(q => ({...q, context: "Na Oficina:"}));
            }
            
            const tiposMuda = module.challengeData.tiposMuda;

            allQuestions.forEach((item, index) => {
                const questionEl = createRadioQuestion(item, index, 'q', null); // dataAttribute (isBest) não é necessário aqui
                questionEl.dataset.answer = item.a; // Marcador para Módulo 2
                ui.challengeArea.appendChild(questionEl);
            });
            
            ui.submitChallengeBtn.onclick = () => submitChallengeRadio(module);
        }

        // Desafio 3: 5S e Kaizen (Genérico)
        function setupChallenge3(module) {
            runChallenge3Step(1, module);
        }

        function runChallenge3Step(step, module) {
            ui.challengeArea.innerHTML = '';
            ui.challengeFeedback.textContent = '';
            ui.submitChallengeBtn.classList.remove('hidden'); 
            
            if (step === 1) { // Etapa 1: Seiri
                ui.challengeTask.textContent = "Etapa 1: SEIRI (Utilização). Clique em TODOS os itens que são inúteis e devem ser JOGADOS FORA.";
                const shuffledData = shuffleArray([...module.challengeData.seiri]);
                
                shuffledData.forEach(item => {
                    const itemEl = createOptionItem(item.item, { 'isUseless': item.isUseless });
                    ui.challengeArea.appendChild(itemEl);
                });
                
                ui.submitChallengeBtn.onclick = () => {
                    const options = ui.challengeArea.querySelectorAll('.option-item');
                    const { correct, wrong } = checkMultiSelect(options, 'isUseless');
                    const points = (correct * module.pointsPerCorrect) + (wrong * module.pointsPerWrong);
                    updateScore(points);
                    
                    ui.challengeFeedback.textContent = `Seiri: ${correct} itens inúteis identificados!`;
                    ui.submitChallengeBtn.classList.add('hidden'); 
                    setTimeout(() => runChallenge3Step(2, module), 2500); 
                };

            } else if (step === 2) { // Etapa 2: Seiton
                ui.challengeTask.textContent = "Etapa 2: SEITON (Organização). Clique em TODOS os itens que estão no LOCAL ERRADO.";
                const shuffledData = shuffleArray([...module.challengeData.seiton]);
                
                shuffledData.forEach(item => {
                    const isWrongPlace = item.local !== item.localCorreto;
                    const itemEl = createOptionItem(`${item.item} (está em: ${item.local})`, { 'isWrongPlace': isWrongPlace });
                    ui.challengeArea.appendChild(itemEl);
                });
                
                ui.submitChallengeBtn.onclick = () => {
                    const options = ui.challengeArea.querySelectorAll('.option-item');
                    const { correct, wrong } = checkMultiSelect(options, 'isWrongPlace');
                    const points = (correct * module.pointsPerCorrect) + (wrong * module.pointsPerWrong);
                    updateScore(points);
                    
                    ui.challengeFeedback.textContent = `Seiton: ${correct} itens no lugar errado identificados!`;
                    ui.submitChallengeBtn.classList.add('hidden'); 
                    setTimeout(() => runChallenge3Step(3, module), 2500); 
                };

            } else if (step === 3) { // Etapa 3: Kaizen
                ui.challengeTask.textContent = "Etapa 3: KAIZEN (Melhoria). Escolha a MELHOR solução (pequena, barata, inteligente) para cada problema.";
                
                shuffleArray([...module.challengeData.kaizen]).forEach((item, index) => {
                    const questionEl = createRadioQuestion(item, index, 'k', 'isBest');
                    ui.challengeArea.appendChild(questionEl);
                });

                ui.submitChallengeBtn.onclick = () => {
                    submitChallengeRadio(module);
                };
            }
        }
        
        // Desafio 4: Kanban e Poka-Yoke (Genérico)
        function setupChallenge4(module) {
            runChallenge4Step(1, module);
        }

        function runChallenge4Step(step, module) {
            ui.challengeArea.innerHTML = '';
            ui.challengeFeedback.textContent = '';
            ui.submitChallengeBtn.classList.remove('hidden');
            const isPizzaria = module.name.includes("Módulo 4");

            if (step === 1) { // Etapa 1: Kanban
                ui.challengeTask.textContent = "Etapa 1: KANBAN (Gestão Visual).";
                
                let kanbanHTML = '';
                if (isPizzaria) {
                    kanbanHTML = `
                        <div class="kanban-board mb-4">
                            <div class="kanban-column"><div class="kanban-column-title">A Fazer (WIP: ∞)</div><div class="kanban-card">Pedido #101</div><div class="kanban-card">Pedido #102</div></div>
                            <div class="kanban-column bottleneck"><div class="kanban-column-title">Em Preparo (WIP: 3)</div><div class="kanban-card">#096</div><div class="kanban-card">#097</div><div class="kanban-card">#098</div><div class="kanban-card">#099</div><div class="kanban-card">#100</div></div>
                            <div class="kanban-column"><div class="kanban-column-title">Assando (WIP: 2)</div><div class="kanban-card">#095</div></div>
                            <div class="kanban-column"><div class="kanban-column-title">Pronto (WIP: 5)</div><div class="kanban-card">#094</div></div>
                        </div>`;
                } else {
                    kanbanHTML = `
                        <div class="kanban-board mb-4">
                            <div class="kanban-column"><div class="kanban-column-title">Recepção (WIP: ∞)</div><div class="kanban-card">Carro A</div><div class="kanban-card">Carro B</div></div>
                            <div class="kanban-column"><div class="kanban-column-title">Diagnóstico (WIP: 2)</div><div class="kanban-card">Carro C</div></div>
                            <div class="kanban-column bottleneck"><div class="kanban-column-title">Aguardando Peça (WIP: 4)</div><div class="kanban-card">Carro D</div><div class="kanban-card">Carro E</div><div class="kanban-card">Carro F</div><div class="kanban-card">Carro G</div><div class="kanban-card">Carro H</div></div>
                            <div class="kanban-column"><div class="kanban-column-title">Em Conserto (WIP: 3)</div><div class="kanban-card">Carro I</div></div>
                        </div>`;
                }
                ui.challengeArea.innerHTML += kanbanHTML;
                
                const qData = module.challengeData.kanban;
                const questionEl = createRadioQuestion(qData, 1, 'k', 'isBest');
                ui.challengeArea.appendChild(questionEl);
                
                // [CORRIGIDO] Onclick específico para M4-S1
                ui.submitChallengeBtn.onclick = () => {
                    const { correct, wrong, total } = checkRadioAnswers(module);
                    
                    if (total === 0) {
                        console.error("M4-S1: checkRadioAnswers encontrou 0 perguntas.");
                        return; // Evita travar
                    }
                    
                    let points = (correct * module.pointsPerCorrect) + (wrong * module.pointsPerWrong);
                    
                    // Adiciona bônus do Kanban se acertar
                    if (correct > 0) {
                        points += 25; 
                    }
                    
                    updateScore(points);
                    
                    ui.challengeFeedback.textContent = `Kanban: ${correct > 0 ? 'Gargalo identificado! (+25 pts Bônus)' : 'Não identificou o gargalo!'}`;
                    ui.submitChallengeBtn.classList.add('hidden');
                    
                    // [CORRIGIDO] Chama a próxima etapa
                    setTimeout(() => runChallenge4Step(2, module), 3000);
                };

            } else if (step === 2) { // Etapa 2: Poka-Yoke
                ui.challengeTask.textContent = "Etapa 2: POKA-YOKE (À Prova de Erros). Escolha a MELHOR solução à prova de erros.";
                
                shuffleArray([...module.challengeData.pokaYoke]).forEach((item, index) => {
                    const questionEl = createRadioQuestion(item, index, 'p', 'isBest');
                    ui.challengeArea.appendChild(questionEl);
                });

                // [CORRIGIDO] Chama o handler final
                ui.submitChallengeBtn.onclick = () => {
                    submitChallengeRadio(module);
                };
            }
        }

        
        // --- Funções Auxiliares de Desafio (Genéricas) ---
        
        function createOptionItem(text, dataAttributes) {
            const itemEl = document.createElement('div');
            itemEl.className = 'option-item bg-gray-700 p-4 rounded-lg cursor-pointer border-2 border-gray-600';
            itemEl.textContent = text;
            for (const key in dataAttributes) {
                itemEl.dataset[key] = dataAttributes[key];
            }
            itemEl.onclick = () => {
                itemEl.classList.toggle('selected');
            };
            return itemEl;
        }
        
        function checkMultiSelect(options, dataAttribute) {
            let correct = 0;
            let wrong = 0;

            options.forEach(opt => {
                const isCorrect = opt.dataset[dataAttribute] === 'true';
                const isSelected = opt.classList.contains('selected');

                if (isCorrect && isSelected) {
                    correct++;
                    opt.classList.add('correct');
                } else if (!isCorrect && isSelected) {
                    wrong++;
                    opt.classList.add('wrong');
                } else if (isCorrect && !isSelected) {
                    wrong++;
                    opt.classList.add('wrong');
                }
                opt.classList.add('disabled');
                opt.onclick = null;
            });
            
            return { correct, wrong };
        }

        function createRadioQuestion(item, index, namePrefix, dataAttribute) {
            const questionEl = document.createElement('div');
            questionEl.className = 'bg-gray-700 p-4 rounded-lg border border-gray-600';
            let optionsHTML = '';
            
            shuffleArray([...item.options]).forEach(opt => {
                optionsHTML += `
                    <label class="block p-2 rounded hover:bg-gray-600">
                        <input type="radio" name="${namePrefix}_${index}" value="${opt[dataAttribute]}" class="form-radio text-cyan-500 bg-gray-800 border-gray-600">
                        <span class="ml-2">${opt.text}</span>
                    </label>
                `;
            });
            
            questionEl.innerHTML = `<p class="font-semibold mb-2">${item.q}</p><div>${optionsHTML}</div>`;
            
            // Marcador para encontrar a pergunta
            if (dataAttribute === 'isBest') {
                questionEl.dataset.isBest = 'true';
            }
            // data-answer (para M2) é adicionado na função setupChallenge2
            return questionEl;
        }
        
        /**
         * [BUG CORRIGIDO] Checa desafios de radio button (M2, M3.3, M4.1, M4.2)
         */
        function checkRadioAnswers(module) {
            let correctSelections = 0;
            let wrongSelections = 0;
            let questions = [];

            if (module.id === 2) {
                // Módulo 2 (Muda)
                questions = ui.challengeArea.querySelectorAll('div[data-answer]');
                questions.forEach(q => {
                    const selectedInput = q.querySelector('input[type="radio"]:checked');
                    const correctAnswerValue = q.dataset.answer;
                    const correctEl = q.querySelector(`input[value="${CSS.escape(correctAnswerValue)}"]`);
                    
                    q.querySelectorAll('input').forEach(inp => inp.disabled = true);
                    if (selectedInput) {
                        if (selectedInput.value === correctAnswerValue) {
                            correctSelections++;
                            selectedInput.parentElement.classList.add('text-green-400', 'font-bold');
                        } else {
                            wrongSelections++;
                            selectedInput.parentElement.classList.add('text-red-400', 'line-through');
                            if (correctEl) correctEl.parentElement.classList.add('text-green-400', 'font-bold');
                        }
                    } else {
                        wrongSelections++;
                        if (correctEl) correctEl.parentElement.classList.add('text-green-400', 'font-bold');
                    }
                });
            } else if (module.id === 3 || module.id === 4) {
                // Módulo 3 (Kaizen) e Módulo 4 (Kanban, Poka-Yoke)
                questions = ui.challengeArea.querySelectorAll('div[data-isBest="true"]');
                questions.forEach(q => {
                    const selectedInput = q.querySelector('input[type="radio"]:checked');
                    const correctAnswerValue = 'true';
                    const correctEl = q.querySelector(`input[value="true"]`);

                    q.querySelectorAll('input').forEach(inp => inp.disabled = true);
                    if (selectedInput) {
                        if (selectedInput.value === correctAnswerValue) {
                            correctSelections++;
                            selectedInput.parentElement.classList.add('text-green-400', 'font-bold');
                        } else {
                            wrongSelections++;
                            selectedInput.parentElement.classList.add('text-red-400', 'line-through');
                            if (correctEl) correctEl.parentElement.classList.add('text-green-400', 'font-bold');
                        }
                    } else {
                        wrongSelections++;
                        if (correctEl) correctEl.parentElement.classList.add('text-green-400', 'font-bold');
                    }
                });
            }
            
            return { correct: correctSelections, wrong: wrongSelections, total: questions.length };
        }


        /**
         * [CORRIGIDO] Submissão genérica para radio-buttons (Desafios 2, 3.3, 4.2)
         */
        function submitChallengeRadio(module) {
            const { correct, wrong, total } = checkRadioAnswers(module);
            
            if (total === 0) {
                 console.error(`submitChallengeRadio (M${module.id}): checkRadioAnswers encontrou 0 perguntas.`);
                 return; // Evita travar
            }

            let points = (correct * module.pointsPerCorrect) + (wrong * module.pointsPerWrong);
            
            updateScore(points);
            
            ui.submitChallengeBtn.classList.add('hidden');
            const message = `Você acertou ${correct} de ${total}.`;
            setTimeout(() => showResult(true, message), 4000); 
        }


        // --- FUNÇÕES ANTI-CHEAT ---
        
        function showToast(message) {
            if (gameState.toastTimer) {
                clearTimeout(gameState.toastTimer);
            }
            ui.toast.textContent = message;
            ui.toast.classList.add('active');
            gameState.toastTimer = setTimeout(() => {
                ui.toast.classList.remove('active');
            }, 3000);
        }

        function handleCheat() {
            if (!screens.challenge.classList.contains('active')) {
                return;
            }
            if (gameState.isCheating) {
                return;
            }
            
            gameState.isCheating = true;
            gameState.cheatAttempts++;
            updateScore(-150); 
            
            showToast("COMPORTAMENTO SUSPEITO! Penalidade: -150 Pontos");
            
            setTimeout(() => {
                gameState.isCheating = false;
            }, 3000); 
        }


        // --- INICIALIZAÇÃO E EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Botão de Iniciar Jogo (Nível 1)
            ui.startGameBtn.addEventListener('click', startGame);
            
            // Botão de Iniciar Nível 2
            ui.startLevel2BtnWelcome.addEventListener('click', startLevel2);

            // Botão de Voltar ao Início (Tela Final)
            ui.goHomeBtn.addEventListener('click', goHome);
            
            // --- Eventos Anti-Cheat ---
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) handleCheat();
            });
            window.addEventListener('blur', handleCheat);
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'PrintScreen') {
                    e.preventDefault(); 
                    handleCheat();
                }
                if ((e.metaKey || e.ctrlKey) && e.shiftKey) {
                    if (['3', '4', 's', 'S'].includes(e.key)) {
                        e.preventDefault();
                        handleCheat();
                    }
                }
            });
        });

    </script>
</body>
</html>

